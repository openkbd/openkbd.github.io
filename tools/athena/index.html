<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport"content="width=device-width, initial-scale=1.0"><title>GIF to UF2 for Athena1800</title><link rel="stylesheet"href="https://s4.zstatic.net/ajax/libs/noUiSlider/15.7.1/nouislider.min.css"/><link rel="stylesheet"href="https://s4.zstatic.net/ajax/libs/cropperjs/1.6.2/cropper.min.css"/><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;padding:2rem 0;margin:0;background-color:#f0f2f5}.container,.preview-container{width:90%;max-width:600px;padding:2rem;background-color:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);text-align:center;margin-bottom:1.5rem}h1,h3{color:#333;margin-top:0}p{color:#666;margin-bottom:0.75rem}.controls{display:flex;flex-direction:column;gap:1rem;align-items:center}button{padding:0.6rem 1.2rem;font-size:1rem;border:none;border-radius:5px;cursor:pointer;background-color:#007bff;color:white;transition:background-color:0.2s}button:disabled{background-color:#cccccc;cursor:not-allowed}.uf2-buttons{display:flex;flex-direction:column;gap:0.5rem;width:100%;margin-top:1rem;border-top:1px solid#eee;padding-top:1rem}.uf2-row{display:flex;justify-content:center;gap:0.5rem}.uf2-row button{flex:1}.privacy-notice{font-size:0.8rem;color:#888;margin-top:-0.5rem}.file-status{font-size:0.9rem;color:#28a745;font-weight:bold;height:1.2em;margin-bottom:0.75rem}.preview-info-text{font-size:0.9rem;color:#555;height:1.2em;margin-top:-0.5rem;margin-bottom:1rem}.preview-container{border:2px dashed#cccccc}.preview-pair{display:flex;justify-content:space-around;gap:1rem;align-items:center}.preview-box{flex:1}.preview-box img,.preview-box canvas{max-width:100%;max-height:200px;border:1px solid#ddd;border-radius:4px}#gifPreviewContainer{max-width:100%}#gifPreview{display:block;max-width:100%}#frameCountDisplay{font-weight:bold;color:#333;margin-top:1rem;margin-bottom:0}.frame-slider-control{margin-top:1.5rem;padding:0 1rem}.slider-labels{display:flex;justify-content:space-between;margin-top:0.5rem;font-size:0.9rem}.language-switcher{position:absolute;top:1rem;right:1rem}#langSwitchButton{background-color:#6c757d;padding:0.4rem 0.8rem;font-size:0.9rem}.hidden{display:none}#gif-container{display:none}</style></head><body><div class="language-switcher"><button id="langSwitchButton"data-i18n-key="langSwitchText">中/EN</button></div><div class="container"><h1 data-i18n-key="mainTitle">GIF to UF2 for Athena1800</h1><p data-i18n-key="subtitle">上传GIF，拖动选框确定范围，程序将把该区域转换为128x128的动画。<br>请注意用作大小写和打字，要小于31帧。其他的小于63帧。</p><div class="controls"><button id="customUploadButton"data-i18n-key="uploadButtonText"disabled>选择GIF文件</button><input type="file"id="fileUploader"accept=".gif"class="hidden"><p class="privacy-notice"data-i18n-key="privacyNotice">图片不会上传至互联网，仅在本地处理。</p><button id="processButton"class="hidden"disabled data-i18n-key="processButtonText">确认裁剪并处理</button><div id="saveControls"class="hidden"><div class="uf2-buttons"><div class="uf2-row"><button class="uf2-button"id="saveUf2_0"data-i18n-key="gif0ButtonText">GIF0_CapsLock</button><button class="uf2-button"id="saveUf2_1"data-i18n-key="gif1ButtonText">GIF1_Typing</button></div><div class="uf2-row"><button class="uf2-button"id="saveUf2_2">GIF2</button><button class="uf2-button"id="saveUf2_3">GIF3</button><button class="uf2-button"id="saveUf2_4">GIF4</button><button class="uf2-button"id="saveUf2_5">GIF5</button></div></div></div></div></div><div id="previewArea"class="preview-container hidden"><h3 data-i18n-key="previewTitle">预览与裁剪</h3><p id="fileStatus"class="file-status"></p><p id="frameCountDisplay"></p><div class="preview-pair"><div class="preview-box"><h4 data-i18n-key="originalPreviewTitle">原图(拖动选框)</h4><div id="gifPreviewContainer"><img id="gifPreview"src=""></div></div><div class="preview-box"><h4 id="convertedPreviewTitle"data-i18n-key="convertedPreviewTitle">预览结果</h4><p id="convertedPreviewInfo"class="preview-info-text"></p><canvas id="rgb565PreviewCanvas"></canvas></div></div><div id="frameSliderControl"class="frame-slider-control hidden"><div id="rangeSlider"></div><div class="slider-labels"><div><span data-i18n-key="startFrameLabel">起始帧</span>:<span id="startFrameLabelValue">1</span></div><div><span data-i18n-key="endFrameLabel">结束帧</span>:<span id="endFrameLabelValue">1</span></div></div><div class="option-control"><label><input type="checkbox"id="halveFramerateCheckbox"><span data-i18n-key="halveFramerateLabel">帧率减半</span></label></div></div></div><div id="gif-container"><img id="gifImage"/></div><script>function loadScripts(urls,finalCallback){const backupUrls=['https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.min.js','https://cdn.jsdelivr.net/npm/libgif@0.0.3/libgif.min.js','https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js','https://cdn.jsdelivr.net/npm/pica@9.0.1/dist/pica.min.js','https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js'];const promises=urls.map((url,index)=>new Promise((resolve,reject)=>{loadWithBackup(url,backupUrls[index],resolve,reject)}));Promise.all(promises).then(finalCallback).catch(error=>{console.error("一个或多个库加载失败:",error);alert("页面资源加载失败，可能原因是: 部分cdn网址无法正常访问。")});function loadWithBackup(primaryUrl,backupUrl,resolve,reject){const script=document.createElement('script');script.src=primaryUrl;script.onload=()=>{console.log(`库已加载:${primaryUrl}`);resolve()};script.onerror=()=>{console.error(`无法加载脚本:${primaryUrl}，尝试备用链接:${backupUrl}`);if(backupUrl){const backupScript=document.createElement('script');backupScript.src=backupUrl;backupScript.onload=()=>{console.log(`库已通过备用链接加载:${backupUrl}`);resolve()};backupScript.onerror=()=>{console.error(`无法加载脚本:${backupUrl}`);reject(new Error(`无法加载脚本:${primaryUrl}和${backupUrl}`))};document.head.appendChild(backupScript)}else{reject(new Error(`无法加载脚本:${primaryUrl}`))}};document.head.appendChild(script)}}loadScripts(['https://s4.zstatic.net/npm/omggif@1.0.10/omggif.js','https://s4.zstatic.net/npm/libgif@0.0.3/libgif.js','https://s4.zstatic.net/ajax/libs/cropperjs/1.6.2/cropper.min.js','https://s4.zstatic.net/ajax/libs/pica/9.0.1/pica.min.js','https://s4.zstatic.net/ajax/libs/noUiSlider/15.7.1/nouislider.min.js'],runApp);function runApp(){let processedFramesData=[],gifInfo={},originalFilename='',cropper=null,superGifInstance=null,currentLang='en';const uploader=document.getElementById('fileUploader'),customUploadButton=document.getElementById('customUploadButton'),processButton=document.getElementById('processButton'),saveControls=document.getElementById('saveControls'),previewArea=document.getElementById('previewArea'),gifPreview=document.getElementById('gifPreview'),frameCountDisplay=document.getElementById('frameCountDisplay'),gifImage=document.getElementById('gifImage'),rgb565PreviewCanvas=document.getElementById('rgb565PreviewCanvas'),frameSliderControl=document.getElementById('frameSliderControl'),langSwitchButton=document.getElementById('langSwitchButton'),fileStatus=document.getElementById('fileStatus');const rangeSlider=document.getElementById('rangeSlider'),startFrameLabelValue=document.getElementById('startFrameLabelValue'),endFrameLabelValue=document.getElementById('endFrameLabelValue'),convertedPreviewTitle=document.getElementById('convertedPreviewTitle'),convertedPreviewInfo=document.getElementById('convertedPreviewInfo'),halveFramerateCheckbox=document.getElementById('halveFramerateCheckbox');let rangeSliderInstance=null;const translations={en:{fileStatusLabel:"Current File: ",uploadButtonText:"Select GIF File",htmlTitle:"GIF to UF2 for Athena1800",mainTitle:"GIF to UF2 for Athena1800",subtitle:"Upload a GIF, drag the selection to define the crop area, and the tool will convert it to a 128x128 animation.<br>Note: GIFs for CapsLock and Typing should be under 31 frames. Others should be under 63 frames.",privacyNotice:"Images are not uploaded and are processed locally in your browser.",processButtonText:"Confirm Crop & Process",processButtonTexting:"Processing...",gif0ButtonText:"GIF0_CapsLock",gif1ButtonText:"GIF1_Typing",previewTitle:"Preview & Crop",originalPreviewTitle:"Original (Drag to crop)",convertedPreviewTitle:"Preview Result",frameCountUnit:"{count} frames",startFrameLabel:"Start Frame",endFrameLabel:"End Frame",halveFramerateLabel:"Halve Framerate",langSwitchText:"中文",frameCountText:"Total Frames",frameIntervalText:"Avg. Interval",alert_metadata_fail:"Could not parse GIF metadata. The file may be corrupt.",alert_no_data:"No data available to save!",alert_too_many_frames_31:(count)=>`Animation has ${count}frames,which is more than the allowed 31.Please reduce the frame range and try again.`,alert_too_many_frames_63:(count)=>`Animation has ${count}frames,which is more than the allowed 63.Please reduce the frame range and try again.`},zh:{fileStatusLabel:"当前文件: ",uploadButtonText:"选择GIF文件",htmlTitle:"GIF to UF2 for Athena1800",mainTitle:"GIF to UF2 for Athena1800",subtitle:"上传GIF，拖动选框确定范围，程序将把该区域转换为128x128的动画。<br>请注意用作大小写和打字，要小于31帧。其他的小于63帧。",privacyNotice:"图片不会上传至互联网，仅在本地处理。",processButtonText:"确认裁剪并处理",processButtonTexting:"正在处理...",gif0ButtonText:"GIF0_CapsLock",gif1ButtonText:"GIF1_Typing",previewTitle:"预览与裁剪",originalPreviewTitle:"原图 (拖动选框)",convertedPreviewTitle:"预览结果",frameCountUnit:"共 {count} 帧",startFrameLabel:"起始帧",endFrameLabel:"结束帧",halveFramerateLabel:"帧率减半",langSwitchText:"English",frameCountText:"总帧数",frameIntervalText:"平均间隔",alert_metadata_fail:"无法解析GIF元数据。文件可能已损坏。",alert_no_data:"没有可保存的数据！",alert_too_many_frames_31:(count)=>`动画有${count}帧，大于31帧的限制。请减少帧范围后再尝试下载。`,alert_too_many_frames_63:(count)=>`动画有${count}帧，大于63帧的限制。请减少帧范围后再尝试下载。`}};const UF2_BUTTON_CONFIG=[{id:'saveUf2_0',address:0x10400000},{id:'saveUf2_1',address:0x10500000},{id:'saveUf2_2',address:0x10600000},{id:'saveUf2_3',address:0x10800000},{id:'saveUf2_4',address:0x10A00000},{id:'saveUf2_5',address:0x10C00000},];let animationFrameId=null,playbackStartIndex=0,playbackEndIndex=0,currentPlaybackFrameIndex=0,lastFrameTimestamp=0;let playbackFrames=[];let isFramerateHalved=false;customUploadButton.disabled=false;function updateDynamicHeaders(){if(!gifInfo||!gifInfo.frameCount){frameCountDisplay.textContent='';convertedPreviewInfo.textContent='';convertedPreviewTitle.textContent=translations[currentLang].convertedPreviewTitle;return};const frameCountStr=`${translations[currentLang].frameCountText}:${gifInfo.frameCount}`;const delayStr=`|${translations[currentLang].frameIntervalText.replace('Avg.','Initial')}:${gifInfo.delays[0]||0}ms`;frameCountDisplay.textContent=frameCountStr+(gifInfo.frameCount>1?delayStr:"");convertedPreviewTitle.textContent=translations[currentLang].convertedPreviewTitle;let selectedFrameCount=0;if(processedFramesData.length>0){selectedFrameCount=playbackFrames.length}const frameUnitText=translations[currentLang].frameCountUnit.replace('{count}',selectedFrameCount);if(selectedFrameCount>0){const totalDelay=playbackFrames.reduce((sum,frame)=>sum+frame.delay,0);const avgDelay=Math.round(totalDelay/selectedFrameCount);const avgDelayText=`${translations[currentLang].frameIntervalText}:${avgDelay}ms`;convertedPreviewInfo.textContent=`${frameUnitText}|${avgDelayText}`}else{convertedPreviewInfo.textContent=frameUnitText}}function setLanguage(lang){currentLang=lang;document.documentElement.lang=lang;document.title=translations[lang].htmlTitle;document.querySelectorAll('[data-i18n-key]').forEach(el=>{const key=el.getAttribute('data-i18n-key');if(translations[lang][key]&&el.id!=='convertedPreviewTitle'){el.innerHTML=translations[lang][key]}});updateDynamicHeaders();if(originalFilename){fileStatus.textContent=translations[lang].fileStatusLabel+originalFilename}}function resetUIState(){if(animationFrameId){cancelAnimationFrame(animationFrameId);animationFrameId=null}if(rangeSliderInstance){rangeSliderInstance.destroy();rangeSliderInstance=null}processButton.classList.add('hidden');processButton.disabled=true;saveControls.classList.add('hidden');frameSliderControl.classList.add('hidden');previewArea.classList.add('hidden');const ctx=rgb565PreviewCanvas.getContext('2d');ctx.clearRect(0,0,rgb565PreviewCanvas.width,rgb565PreviewCanvas.height);if(cropper){cropper.destroy();cropper=null}processedFramesData=[];playbackFrames=[];gifInfo={};fileStatus.textContent='';frameCountDisplay.textContent='';convertedPreviewInfo.textContent='';convertedPreviewTitle.textContent=translations[currentLang].convertedPreviewTitle;halveFramerateCheckbox.checked=false;isFramerateHalved=false}function handleFileSelect(event){const file=event.target.files[0];uploader.value=null;resetUIState();if(!file){return}originalFilename=file.name;fileStatus.textContent=translations[currentLang].fileStatusLabel+originalFilename;const reader=new FileReader();reader.readAsArrayBuffer(file);reader.onload=function(e){const arrayBuffer=e.target.result;try{const u8array=new Uint8Array(arrayBuffer);const gifReader=new GifReader(u8array);gifInfo={frameCount:gifReader.numFrames(),delays:[],width:gifReader.width,height:gifReader.height};for(let i=0;i<gifInfo.frameCount;i++){gifInfo.delays.push(gifReader.frameInfo(i).delay*10)}updateDynamicHeaders()}catch(error){alert(translations[currentLang].alert_metadata_fail);return}const blob=new Blob([arrayBuffer],{type:'image/gif'});const objectURL=URL.createObjectURL(blob);gifPreview.src=objectURL;gifImage.src=objectURL;previewArea.classList.remove('hidden');cropper=new Cropper(gifPreview,{aspectRatio:1/1,viewMode:1,background:false,responsive:true,ready:function(){const imageData=this.cropper.getImageData();const sideLength=Math.min(imageData.naturalWidth,imageData.naturalHeight);this.cropper.setData({x:(imageData.naturalWidth-sideLength)/2,y:(imageData.naturalHeight-sideLength)/2,width:sideLength,height:sideLength})}});superGifInstance=new SuperGif({gif:gifImage});superGifInstance.load(()=>{processButton.disabled=false;processButton.classList.remove('hidden')})}}async function processCroppedGif(){if(!cropper||!superGifInstance)return;processButton.disabled=true;processButton.textContent=translations[currentLang].processButtonTexting;cropper.disable();const cropData=cropper.getData(true);const TARGET_SIZE=128;const{frameCount}=gifInfo;processedFramesData=[];const picaInstance=pica();const cropSourceCanvas=document.createElement('canvas'),cropSourceCtx=cropSourceCanvas.getContext('2d');cropSourceCanvas.width=cropData.width;cropSourceCanvas.height=cropData.height;const picaTargetCanvas=document.createElement('canvas');picaTargetCanvas.width=TARGET_SIZE;picaTargetCanvas.height=TARGET_SIZE;for(let i=0;i<frameCount;i++){superGifInstance.move_to(i);const frameCanvas=superGifInstance.get_canvas();cropSourceCtx.clearRect(0,0,cropData.width,cropData.height);cropSourceCtx.drawImage(frameCanvas,cropData.x,cropData.y,cropData.width,cropData.height,0,0,cropData.width,cropData.height);await picaInstance.resize(cropSourceCanvas,picaTargetCanvas);const picaCtx=picaTargetCanvas.getContext('2d');const rgbaPixels=picaCtx.getImageData(0,0,TARGET_SIZE,TARGET_SIZE).data;const frameRgb565Data=new Uint16Array(TARGET_SIZE*TARGET_SIZE);let rgb565Index=0;for(let p=0;p<rgbaPixels.length;p+=4){const r=rgbaPixels[p],g=rgbaPixels[p+1],b=rgbaPixels[p+2];frameRgb565Data[rgb565Index++]=((r>>3)<<11)|((g>>2)<<5)|(b>>3)}processedFramesData.push(frameRgb565Data)}gifInfo.width=TARGET_SIZE;gifInfo.height=TARGET_SIZE;processButton.classList.add('hidden');processButton.textContent=translations[currentLang].processButtonText;saveControls.classList.remove('hidden');setupRangeSliders();updatePlaybackData();startAnimation()}function renderRgb565Frame(frameIndex){if(!processedFramesData[frameIndex])return;const TARGET_SIZE=128;const frameData=processedFramesData[frameIndex];const ctx=rgb565PreviewCanvas.getContext('2d');rgb565PreviewCanvas.width=TARGET_SIZE;rgb565PreviewCanvas.height=TARGET_SIZE;const imageData=ctx.createImageData(TARGET_SIZE,TARGET_SIZE);const rgbaPixels=imageData.data;for(let i=0;i<frameData.length;i++){const rgb565=frameData[i];let r=(rgb565&0b1111100000000000)>>11,g=(rgb565&0b0000011111100000)>>5,b=(rgb565&0b0000000000011111);r=(r<<3)|(r>>2);g=(g<<2)|(g>>4);b=(b<<3)|(b>>2);const pixelIndex=i*4;rgbaPixels[pixelIndex]=r;rgbaPixels[pixelIndex+1]=g;rgbaPixels[pixelIndex+2]=b;rgbaPixels[pixelIndex+3]=255}ctx.putImageData(imageData,0,0)}function animationLoop(timestamp){if(playbackFrames.length===0)return;if(!lastFrameTimestamp){lastFrameTimestamp=timestamp}const elapsed=timestamp-lastFrameTimestamp;const currentFrame=playbackFrames[currentPlaybackFrameIndex];if(!currentFrame)return;const requiredDelay=currentFrame.delay||100;if(elapsed>=requiredDelay){renderRgb565Frame(currentFrame.originalIndex);lastFrameTimestamp=timestamp;currentPlaybackFrameIndex++;if(currentPlaybackFrameIndex>=playbackFrames.length){currentPlaybackFrameIndex=0}}animationFrameId=requestAnimationFrame(animationLoop)}function startAnimation(){if(animationFrameId){cancelAnimationFrame(animationFrameId)}currentPlaybackFrameIndex=0;lastFrameTimestamp=0;animationFrameId=requestAnimationFrame(animationLoop)}function updatePlaybackData(){playbackFrames=[];const step=isFramerateHalved?2:1;for(let i=playbackStartIndex;i<=playbackEndIndex;i+=step){let delay=gifInfo.delays[i]||0;if(isFramerateHalved&&i+1<=playbackEndIndex){delay+=gifInfo.delays[i+1]||0}playbackFrames.push({originalIndex:i,delay:delay,data:processedFramesData[i]})}updateDynamicHeaders()}function setupRangeSliders(){const frameCount=gifInfo.frameCount;if(frameCount<=1){frameSliderControl.classList.add('hidden');playbackStartIndex=0;playbackEndIndex=0;return}if(rangeSliderInstance){rangeSliderInstance.destroy()}playbackStartIndex=0;playbackEndIndex=frameCount-1;updateDynamicHeaders();rangeSliderInstance=noUiSlider.create(rangeSlider,{start:[1,frameCount],connect:true,step:1,range:{'min':1,'max':frameCount},format:{to:value=>Math.round(value),from:value=>Number(value)}});rangeSliderInstance.on('update',(values,handle)=>{const[start,end]=values.map(v=>parseInt(v,10));startFrameLabelValue.textContent=start;endFrameLabelValue.textContent=end});rangeSliderInstance.on('set',(values,handle)=>{const[start,end]=values.map(v=>parseInt(v,10));playbackStartIndex=start-1;playbackEndIndex=end-1;updatePlaybackData();startAnimation()});frameSliderControl.classList.remove('hidden')}function generateQgfBuffer(){updatePlaybackData();const framesToSave=playbackFrames;const numFramesToSave=framesToSave.length;if(numFramesToSave===0){alert(translations[currentLang].alert_no_data);return null}console.log(`将要保存${numFramesToSave}帧(根据选择范围和帧率设置)。`);const PER_FRAME_HEADER_TEMPLATE=[0x02,0xFD,0x06,0x00,0x00,0x08,0x00,0x00,0xFF,0x00,0x00,0x05,0xFA,0x00,0x80,0x00];const PER_FRAME_HEADER_SIZE=PER_FRAME_HEADER_TEMPLATE.length;const framePixelDataSize=gifInfo.width*gifInfo.height*2;const singleFrameBlockSize=PER_FRAME_HEADER_SIZE+framePixelDataSize;const masterHeaderSize=(numFramesToSave*4)+28;const totalFileSize=masterHeaderSize+(singleFrameBlockSize*numFramesToSave);const buffer=new ArrayBuffer(totalFileSize);const dataView=new DataView(buffer);let byteOffset=0;const fixedMasterHeader=[0x00,0xFF,0x12,0x00,0x00,0x51,0x47,0x46,0x01];fixedMasterHeader.forEach(byte=>dataView.setUint8(byteOffset++,byte));dataView.setUint32(byteOffset,totalFileSize,true);byteOffset+=4;dataView.setUint32(byteOffset,~totalFileSize,true);byteOffset+=4;dataView.setUint16(byteOffset,gifInfo.width,true);byteOffset+=2;dataView.setUint16(byteOffset,gifInfo.height,true);byteOffset+=2;dataView.setUint16(byteOffset,numFramesToSave,true);byteOffset+=2;dataView.setUint8(byteOffset++,0x01);dataView.setUint8(byteOffset++,0xFE);const tableSize=numFramesToSave*4;dataView.setUint8(byteOffset++,tableSize&0xFF);dataView.setUint8(byteOffset++,(tableSize>>8)&0xFF);dataView.setUint8(byteOffset++,(tableSize>>16)&0xFF);for(let i=0;i<numFramesToSave;i++){const frameOffset=masterHeaderSize+(i*singleFrameBlockSize);dataView.setUint32(byteOffset,frameOffset,true);byteOffset+=4}byteOffset=masterHeaderSize;for(let i=0;i<numFramesToSave;i++){const frame=framesToSave[i];const blockStartOffset=byteOffset;for(const byte of PER_FRAME_HEADER_TEMPLATE){dataView.setUint8(byteOffset++,byte)}const delayWritePosition=blockStartOffset+9;dataView.setUint16(delayWritePosition,frame.delay,true);for(const pixel of frame.data){dataView.setUint16(byteOffset,pixel,false);byteOffset+=2}}return buffer}function convertToUf2(dataBuffer,startAddress){const FAMILY_ID=0xe48bff56;const PAYLOAD_SIZE=256;const numBlocks=Math.ceil(dataBuffer.byteLength/PAYLOAD_SIZE);const uf2Buffer=new ArrayBuffer(numBlocks*512);const uf2View=new DataView(uf2Buffer);const sourceView=new DataView(dataBuffer);for(let i=0;i<numBlocks;i++){const blockOffset=i*512,dataOffset=i*PAYLOAD_SIZE;const currentTargetAddress=startAddress+dataOffset;uf2View.setUint32(blockOffset+0,0x0A324655,true);uf2View.setUint32(blockOffset+4,0x9E5D5157,true);uf2View.setUint32(blockOffset+8,0x00002000,true);uf2View.setUint32(blockOffset+12,currentTargetAddress,true);uf2View.setUint32(blockOffset+16,PAYLOAD_SIZE,true);uf2View.setUint32(blockOffset+20,i,true);uf2View.setUint32(blockOffset+24,numBlocks,true);uf2View.setUint32(blockOffset+28,FAMILY_ID,true);const currentPayloadSize=Math.min(PAYLOAD_SIZE,dataBuffer.byteLength-dataOffset);for(let j=0;j<currentPayloadSize;j++){uf2View.setUint8(blockOffset+32+j,sourceView.getUint8(dataOffset+j))}uf2View.setUint32(blockOffset+508,0x0AB16F30,true)}return uf2Buffer}function triggerDownload(buffer,filename){const blob=new Blob([buffer],{type:'application/octet-stream'});const url=URL.createObjectURL(blob);const link=document.createElement('a');link.href=url;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url)}const browserLangInit=navigator.language||navigator.userLanguage;setLanguage(browserLangInit.startsWith('zh')?'zh':'en');langSwitchButton.addEventListener('click',()=>{setLanguage(currentLang==='en'?'zh':'en')});customUploadButton.addEventListener('click',()=>uploader.click());uploader.addEventListener('change',handleFileSelect);processButton.addEventListener('click',processCroppedGif);halveFramerateCheckbox.addEventListener('change',(e)=>{isFramerateHalved=e.target.checked;if(processedFramesData.length>0){updatePlaybackData();startAnimation()}});UF2_BUTTON_CONFIG.forEach((config,index)=>{document.getElementById(config.id).addEventListener('click',()=>{updatePlaybackData();const framesToSaveCount=playbackFrames.length;if(index<=1){if(framesToSaveCount>31){alert(translations[currentLang].alert_too_many_frames_31(framesToSaveCount));return}}else{if(framesToSaveCount>63){alert(translations[currentLang].alert_too_many_frames_63(framesToSaveCount));return}}const qgfBuffer=generateQgfBuffer();if(qgfBuffer){const uf2Buffer=convertToUf2(qgfBuffer,config.address);const baseName=originalFilename.replace(/\.[^/.]+$/,"");triggerDownload(uf2Buffer,`${baseName}_gif${index}.uf2`)}})})}</script></body></html>